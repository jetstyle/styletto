#!/usr/bin/env node

"use strict";

var packageJson = JSON.parse( require( 'fs' ).readFileSync( __dirname + '/../package.json', 'utf8' ) ),

    APPLICATION_NAME    = packageJson.name,
    APPLICATION_VERSION = packageJson.version,

    fs       = require( 'fs' ),
    path     = require( 'path' ),
    colors   = require( 'colors' ),
    optimist = require( 'optimist' ),

    settings = require( '../lib/settings' ),
    styletto = require( '../lib/styletto' ).init;


// message functions

var showHelp = function() {

    var helpMsg  = '\n';

    helpMsg += 'Usage: ' + APPLICATION_NAME + ' [options] inputFile [outputFile]\n\n';

    helpMsg += 'Options:\n\n';

    helpMsg += '  -h, --help                Displays help information\n';
    helpMsg += '  -v, --version             Displays package version\n';
    helpMsg += '  -c, --compress' + '[=engine]'.yellow + '   Compress output file using either ' + 'csso'.yellow + '\n';
    helpMsg += '                            or ' + 'yui'.yellow + ' compressor, default is ' + 'csso'.yellow + '\n';
    helpMsg += '  -b, --base64' + '[=size]'.yellow + '       Encode images to base64, images that are more\n';
    helpMsg += '                            than "size" value in bytes will not be encoded,\n';
    helpMsg += '                            default size is ' + '10000'.yellow + ' bytes\n';

    helpMsg += '  --path[=dir]              Path to directory from which path to includes and\n';
    helpMsg += '                            resources in inputFile will be resolved, default is\n';
    helpMsg += '                            inputFile directory.\n\n';

    helpMsg += 'Error handling rules: ' + 'error'.yellow + ' will exit process without saving, ' + 'alert'.yellow + ' will print\n';
    helpMsg += 'error text to console but will also try to finish compiling, ' + 'ignore'.yellow + ' will try\n';
    helpMsg += 'to finish compiling without printing an error message.\n\n';

    helpMsg += '  --errors' + '[=rule]'.yellow + '                  Shortcut for all rules at once\n\n';

    helpMsg += '  --errors-imports' + '[=rule]'.yellow + '          Default is ' + 'alert'.yellow + '\n';
    helpMsg += '  --errors-resources' + '[=rule]'.yellow + '        Default is ' + 'ignore'.yellow + '\n';
    helpMsg += '  --errors-processors' + '[=rule]'.yellow + '       Default is ' + 'error'.yellow + '\n';

    console.log( helpMsg );

    process.exit();

};

var showVersion = function() {

    console.log( APPLICATION_NAME + ' ' + APPLICATION_VERSION );

    process.exit();

};

// arguments parsing

var args = optimist.options( {

    help: {
        alias: 'h',
        boolean: true
    },

    version: {
        alias: 'v',
        boolean: true
    },

    compress: {
        alias: 'c',
        short: 'c'
    },

    base64: {
        alias: 'b',
        short: 'b'
    },

    path: {
        default: false
    },

    errors: {},

    'errors-imports': { },

    'errors-resources': { },

    'errors-processors': { }

} ).argv;


// show version

if ( args.version ) {

    showVersion();

}


// show help

var noFileOrShowHelp = ( args._.length === 0 || args.help );

if ( noFileOrShowHelp ) {

    showHelp();

}


// running flags parser

var config = settings( args );

if ( config instanceof Error ) {

    var ERROR_REGEX = /Error:(\s)*/;

    console.error( '\n' + config.toString().replace( ERROR_REGEX, '' ) + '\n' );

    process.exit();

}


// initialising main module with params

styletto( config, function( err, success, css ) {

    if ( err ) {

        if ( !success ) {

            console.error( '\nFile was NOT saved because of following errors:\n\n' + err );

        } else if ( !css ) {

            console.error( '\n' + err + '\nFile was saved to "' +config.output + '" with some warnings.\n' );

        }

        else {

            console.error( err );
            process.stdout.write( css );

        }

    }

    else if ( success ) {

        if ( !css ) {

           console.log( '\nFile was succesfully saved to ' + config.output + '\n' );

        }

        else {

            process.stdout.write( css );

        }

    }

    process.exit();

} );
